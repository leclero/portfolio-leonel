<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Administraci贸n - Leonel Rosales</title>
    <link rel="stylesheet" href="estilos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        // 1. Detecci贸n inmediata para evitar "parpadeo" blanco
        if (localStorage.getItem("modo") === "oscuro") {
            document.documentElement.classList.add("modo-oscuro");
        }
        // 2. Protecci贸n de ruta
        if (localStorage.getItem('adminAuth') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <style>
        .tabla-mensajes {
            width: 100%; border-collapse: collapse; margin-top: 20px;
            background: var(--bg-card); border-radius: 10px; overflow: hidden;
        }
        .tabla-mensajes th, .tabla-mensajes td {
            padding: 15px; text-align: left;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            color: var(--text-main);
        }
        .modo-oscuro .tabla-mensajes td { border-bottom: 1px solid #444; }
        .tabla-mensajes th { background: rgba(0,0,0,0.05); }
        .modo-oscuro .tabla-mensajes th { background: rgba(255,255,255,0.05); }

        /* Bot贸n circular limpio arriba a la derecha */
        .modo-toggle {
            position: fixed; top: 20px; right: 20px;
            width: 45px; height: 45px; border-radius: 50%;
            border: none; background: var(--primary-color);
            color: white; cursor: pointer; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .btn-delete { background: #ff4444; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .btn-delete:hover { background: #cc0000; }
    </style>
</head>
<body>
    <button id="boton-modo" class="modo-toggle" onclick="cambiarModo()" title="Cambiar tema">
        <i class="fas fa-moon"></i>
    </button>

    <header>
        <h1>锔 Panel de Control</h1>
        <div class="btns-group">
            <button onclick="logout()" class="btn" style="background: #dc3545;">Cerrar Sesi贸n</button>
            <a href="index.html" class="btn">Ver Sitio</a>
        </div>
    </header>

    <main class="container">
        <section class="proyecto-principal">
            <h3> Bandeja de Mensajes Recibidos (MongoDB)</h3>
            <div style="overflow-x: auto;">
                <table class="tabla-mensajes">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Remitente</th>
                            <th>Email</th>
                            <th>Mensaje</th>
                            <th>Acci贸n</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-body">
                        <tr><td colspan="5" style="text-align:center; padding: 20px;">Cargando mensajes...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="tech-grid" style="margin-top: 20px;">
            <div class="tech-category">
                <h3>У Accesos Directos Taller</h3>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                    <a href="https://taller-costura.vercel.app" target="_blank" class="btn btn-small btn-verde">Admin Teilor Smith</a>
                    <a href="https://tailor-smith-completa-v1-2-1.onrender.com" target="_blank" class="btn btn-small btn-verde">Admin v2.0</a>
                </div>
            </div>

            <div class="tech-category">
                <h3> Estado del Sistema</h3>
                <p>Backend: <span id="status-backend" style="color: #ffa500;">Verificando...</span></p>
                <p>Base de Datos: <span style="color: #28a745;">Cloud MongoDB</span></p>
            </div>
        </section>
    </main>

    <script src="funciones.js"></script>
    <script>
        const API_URL = "https://backend-leonel-pro.onrender.com/api/mensajes";

        async function cargarMensajes() {
            const tabla = document.getElementById('tabla-body');
            const statusLabel = document.getElementById('status-backend');
            
            try {
                const respuesta = await fetch(API_URL);
                const mensajes = await respuesta.json();
                
                statusLabel.textContent = "Online";
                statusLabel.style.color = "#28a745";

                if (mensajes.length === 0) {
                    tabla.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">No hay mensajes</td></tr>';
                    return;
                }

                tabla.innerHTML = mensajes.map(m => `
                    <tr>
                        <td>${new Date(m.fecha).toLocaleString()}</td>
                        <td>${m.nombre}</td>
                        <td>${m.email}</td>
                        <td>${m.mensaje}</td>
                        <td>
                            <button class="btn-delete" onclick="eliminarMensaje('${m._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                statusLabel.textContent = "Offline";
                statusLabel.style.color = "#dc3545";
                tabla.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px; color: red;">Error de conexi贸n</td></tr>';
            }
        }

        async function eliminarMensaje(id) {
            if(confirm("驴Eliminar este mensaje?")) {
                try {
                    const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                    if (res.ok) cargarMensajes();
                } catch (error) { alert("Error al borrar"); }
            }
        }

        function logout() {
            localStorage.removeItem('adminAuth');
            window.location.href = 'index.html';
        }

        window.onload = cargarMensajes;
    </script>
</body>
</html>